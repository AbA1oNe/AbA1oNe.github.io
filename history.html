<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ€„ éº»å°‡é¢¨é›²æ¦œ (åˆ†é ç‰ˆ)</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #1a202c; color: white; }
    </style>
</head>
<body>
    <div id="app" class="max-w-3xl mx-auto p-4">
        
        <header class="flex flex-col md:flex-row justify-between items-center mb-6 border-b border-gray-600 pb-4 gap-4">
            <h1 class="text-3xl font-bold text-yellow-400">ğŸ† éº»å°‡é¢¨é›²æ¦œ</h1>
            <div class="flex gap-2 w-full md:w-auto">
                <input v-model="searchQuery" placeholder="æœå°‹ç©å®¶..." class="bg-gray-700 text-white px-3 py-2 rounded focus:outline-none focus:ring-2 focus:ring-green-500 w-full md:w-48">
                <a href="index.html" class="bg-gray-600 hover:bg-gray-500 px-4 py-2 rounded text-sm transition whitespace-nowrap flex items-center">å›è¨ˆåˆ†æ¿</a>
            </div>
        </header>

        <div v-if="isLoading" class="text-center text-xl text-gray-400 py-10">
            <div class="animate-pulse">è¼‰å…¥æ­·å²æ•¸æ“šä¸­...</div>
        </div>

        <div v-else>
            <div class="space-y-4 mb-8">
                <div v-if="paginatedPlayers.length === 0" class="text-center text-gray-500 py-8">
                    æ‰¾ä¸åˆ°ç¬¦åˆçš„ç©å®¶
                </div>

                <div v-for="(player, index) in paginatedPlayers" :key="player.name" 
                     class="bg-gray-800 p-4 rounded-lg flex flex-col sm:flex-row items-center justify-between border-l-4 shadow-lg transition hover:bg-gray-750"
                     :class="getRankColor(getActualRank(index))">
                    
                    <div class="flex items-center gap-4 w-full sm:w-auto mb-4 sm:mb-0">
                        <div class="text-3xl font-bold w-12 text-center italic" 
                             :class="getActualRank(index) < 3 ? 'text-yellow-400' : 'text-gray-600'">
                            #{{ getActualRank(index) + 1 }}
                        </div>
                        <div>
                            <div class="text-2xl font-bold text-white tracking-wider">{{ player.name }}</div>
                            <div class="text-xs text-gray-400 flex gap-2 mt-1">
                                <span class="bg-gray-700 px-2 py-0.5 rounded text-blue-300">
                                    å‡å°: {{ player.avgTai }}
                                </span>
                                <span class="bg-gray-700 px-2 py-0.5 rounded text-purple-300">
                                    è‡ªæ‘¸ç‡: {{ player.selfRate }}%
                                </span>
                            </div>
                        </div>
                    </div>

                    <div class="flex items-center gap-6 w-full sm:w-auto justify-between sm:justify-end">
                        <div class="text-center">
                            <div class="text-xs text-gray-500 mb-1">KDå€¼</div>
                            <div class="font-bold text-lg" :class="getKdColor(player.kd)">
                                {{ player.kd }}
                            </div>
                        </div>

                        <div class="text-right min-w-[100px]">
                            <div class="text-3xl font-mono font-bold" :class="player.score >= 0 ? 'text-yellow-400' : 'text-gray-400'">
                                {{ player.score > 0 ? '+' : ''}}{{ player.score }}
                            </div>
                            <div class="text-xs text-gray-500 mt-1">
                                èƒ¡ {{ player.wins }} / æ”¾ {{ player.lose }} / è‡ª {{ player.self }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="totalPages > 1" class="flex justify-center items-center gap-4 mb-8 bg-gray-800 p-3 rounded-lg">
                <button @click="prevPage" :disabled="currentPage === 1" 
                        class="px-4 py-2 rounded bg-gray-700 hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed transition">
                    â—€ ä¸Šä¸€é 
                </button>
                <span class="text-gray-300 font-mono">
                    ç¬¬ {{ currentPage }} / {{ totalPages }} é 
                </span>
                <button @click="nextPage" :disabled="currentPage === totalPages" 
                        class="px-4 py-2 rounded bg-gray-700 hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed transition">
                    ä¸‹ä¸€é  â–¶
                </button>
            </div>

            <div class="bg-gray-800 rounded-lg overflow-hidden">
                <button @click="showRecent = !showRecent" class="w-full p-4 flex justify-between items-center bg-gray-700 hover:bg-gray-600 transition">
                    <h3 class="font-bold text-gray-200">è¿‘æœŸæˆ°æ³ (Latest 20)</h3>
                    <span class="text-gray-400">{{ showRecent ? 'â–¼' : 'â–¶' }}</span>
                </button>
                
                <div v-if="showRecent" class="p-4 space-y-2 text-sm text-gray-400 animate-fade-in">
                    <div v-for="log in recentLogs" :key="log.id" class="flex justify-between items-center border-b border-gray-700 pb-2">
                        <span class="w-24 text-xs">{{ new Date(log.time).toLocaleDateString() }}</span>
                        <div class="flex-1 text-center">
                            <span v-if="log.type === 'draw'" class="text-gray-500">ğŸ’¨ è‡­èŠæµå±€</span>
                            <span v-else>
                                <span class="text-green-400 font-bold">{{ log.winner }}</span>
                                <span class="mx-1 text-gray-500">{{ log.type === 'self' ? 'è‡ªæ‘¸' : 'èƒ¡' }}</span>
                                <span class="text-red-400 font-bold">{{ log.loser === 'ALL' ? 'å¤§å®¶' : log.loser }}</span>
                                <span class="text-xs text-gray-600 ml-1">({{ log.tai }}å°)</span>
                            </span>
                        </div>
                        <span class="w-16 text-right font-mono font-bold" :class="log.type === 'draw' ? 'text-gray-600' : 'text-yellow-500'">
                            {{ log.type === 'draw' ? '-' : '+' + log.amount }}
                        </span>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        const { createApp, ref, computed, onMounted, watch } = Vue;

        // â˜…â˜…â˜… è«‹å¡«å…¥ä½ çš„ Supabase è³‡è¨Š â˜…â˜…â˜…
        const SUPABASE_URL = 'https://hyhmwlbsdvlssfmdsmux.supabase.co'; 
        const SUPABASE_KEY = 'sb_publishable_OZRd4Lcc7gK6aLMmbpxBng_YpSmnfnR'; 
        
        const supabase_con = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        createApp({
            setup() {
                const isLoading = ref(true);
                const logs = ref([]);
                const searchQuery = ref(""); 
                const currentPage = ref(1); 
                const pageSize = 10; 
                const showRecent = ref(false); 

                // æ ¸å¿ƒè¨ˆç®—
                const calculateTransaction = (log, playerName) => {
                    const base = log.base || 30;
                    const point = log.point || 10;
                    const logDealer = log.dealer; 
                    const logDealerCount = log.dealer_count || 0; 
                    const getPay = (tai, isDealerInvolved) => {
                        let effectiveTai = tai;
                        if (isDealerInvolved) effectiveTai += 1 + (logDealerCount);
                        return base + (effectiveTai * point);
                    }
                    if (log.type === 'draw') return 0;
                    if (log.winner === playerName) return log.amount; 
                    if (log.type === 'self') {
                        const winnerIsDealer = (log.winner === logDealer);
                        const amIDealer = (playerName === logDealer);
                        if (winnerIsDealer) return -getPay(log.tai, true);
                        else return amIDealer ? -getPay(log.tai, true) : -getPay(log.tai, false);
                    } else if (log.type === 'discard') {
                        if (log.loser === playerName) {
                            const isDealerInvolved = (log.winner === logDealer || log.loser === logDealer);
                            return -getPay(log.tai, isDealerInvolved);
                        }
                    }
                    return 0;
                };

                const fetchHistory = async () => {
                    isLoading.value = true;
                    const { data, error } = await supabase_con.from('logs').select('*').order('time', { ascending: false });
                    if (error) alert(error.message);
                    else logs.value = data || [];
                    isLoading.value = false;
                };

                // â˜… é‡é»ä¿®æ”¹ï¼šè¨ˆç®—æ‰€æœ‰ç©å®¶æ•¸æ“š (åŒ…å«å¾ LocalStorage è®€å–ç•¶å‰ç©å®¶)
                const allRankedPlayers = computed(() => {
                    const allPlayerNames = new Set();
                    
                    // 1. å¾è³‡æ–™åº« Logs æ‰¾å‡ºå‡ºç¾éçš„äºº
                    logs.value.forEach(log => {
                        if(log.winner) allPlayerNames.add(log.winner);
                        if(log.loser && log.loser !== 'ALL') allPlayerNames.add(log.loser);
                        if(log.dealer) allPlayerNames.add(log.dealer);
                    });

                    // 2. â˜… æ–°å¢ï¼šå˜—è©¦å¾ç€è¦½å™¨ LocalStorage è®€å–ã€Œç›®å‰åº§ä½ä¸Šçš„ç©å®¶ã€
                    // é€™æ¨£å°±ç®—é€™å€‹äººé‚„æ²’èƒ¡éç‰Œï¼Œä¹Ÿæœƒè¢«åŠ å…¥è¨ˆç®—åˆ—è¡¨
                    try {
                        const localSeats = localStorage.getItem('mj_seats');
                        if (localSeats) {
                            const seatsArray = JSON.parse(localSeats);
                            seatsArray.forEach(name => {
                                if (name) allPlayerNames.add(name);
                            });
                        }
                    } catch (e) {
                        console.log("è®€å–æœ¬åœ°åº§ä½å¤±æ•—", e);
                    }

                    const result = [];
                    allPlayerNames.forEach(name => {
                        let score = 0;
                        let wins = 0;
                        let self = 0;
                        let lose = 0;
                        let totalTai = 0;
                        
                        logs.value.forEach(log => {
                            if (log.type === 'draw') return;
                            score += calculateTransaction(log, name);
                            if (log.winner === name) {
                                wins++;
                                totalTai += (log.tai || 0);
                                if (log.type === 'self') self++;
                            }
                            if (log.type === 'discard' && log.loser === name) lose++;
                        });

                        // åˆ¤æ–· KD ç„¡é™å¤§
                        let kdRaw = lose === 0 ? wins : (wins / lose);
                        let kdDisplay = lose === 0 && wins > 0 ? "âˆ" : (Math.round(kdRaw * 100) / 100);
                        if (lose === 0 && wins === 0) kdDisplay = 0;

                        let avgTai = wins === 0 ? 0 : (Math.round((totalTai / wins) * 10) / 10);
                        let selfRate = wins === 0 ? 0 : Math.round((self / wins) * 100);

                        result.push({
                            name: name,
                            score: Math.round(score),
                            wins, lose, self, avgTai, selfRate,
                            kd: kdDisplay,
                            kdVal: kdRaw 
                        });
                    });

                    // æ’åº
                    return result.sort((a, b) => b.score - a.score);
                });

                // æœå°‹éæ¿¾
                const filteredPlayers = computed(() => {
                    if (!searchQuery.value) return allRankedPlayers.value;
                    return allRankedPlayers.value.filter(p => 
                        p.name.toLowerCase().includes(searchQuery.value.toLowerCase())
                    );
                });

                // åˆ†é é‚è¼¯
                const totalPages = computed(() => Math.ceil(filteredPlayers.value.length / pageSize));
                
                const paginatedPlayers = computed(() => {
                    const start = (currentPage.value - 1) * pageSize;
                    const end = start + pageSize;
                    return filteredPlayers.value.slice(start, end);
                });

                const nextPage = () => { if (currentPage.value < totalPages.value) currentPage.value++; }
                const prevPage = () => { if (currentPage.value > 1) currentPage.value--; }

                watch(searchQuery, () => { currentPage.value = 1; });

                const getActualRank = (index) => {
                    return (currentPage.value - 1) * pageSize + index;
                };

                const getRankColor = (rank) => {
                    if (rank === 0) return 'border-yellow-400 bg-gradient-to-r from-gray-800 to-yellow-900/20';
                    if (rank === 1) return 'border-gray-300 bg-gradient-to-r from-gray-800 to-gray-700/50';
                    if (rank === 2) return 'border-orange-600 bg-gradient-to-r from-gray-800 to-orange-900/20';
                    return 'border-gray-700 hover:bg-gray-750';
                };

                const getKdColor = (kd) => {
                    if (kd === "âˆ") return 'text-purple-400';
                    if (kd >= 1) return 'text-green-400';
                    return 'text-red-400';
                };

                const recentLogs = computed(() => logs.value.slice(0, 20));

                onMounted(() => {
                    fetchHistory();
                });

                return {
                    isLoading,
                    searchQuery,
                    paginatedPlayers,
                    currentPage,
                    totalPages,
                    nextPage,
                    prevPage,
                    getActualRank,
                    getRankColor,
                    getKdColor,
                    recentLogs,
                    showRecent
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
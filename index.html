<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éº»å°‡é›²ç«¯è¨ˆåˆ†æ¿</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #1a202c; color: white; }
        .dealer-badge { transition: all 0.3s ease; }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        /* è¼‰å…¥ä¸­çš„é®ç½© */
        .loading-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 999; display: flex; justify-content: center; align-items: center; color: white; font-size: 1.5rem; flex-direction: column; gap: 10px; }
    </style>
</head>
<body>
    <div id="app" class="max-w-2xl mx-auto p-4 pb-24">
        
        <div v-if="isLoading" class="loading-overlay">
            <div>è³‡æ–™åŒæ­¥ä¸­...</div>
            <div class="text-sm text-gray-400">è«‹ç¨å€™</div>
        </div>

        <header class="flex justify-between items-center mb-4 border-b border-gray-600 pb-4">
            <h1 class="text-xl font-bold text-green-400">ğŸ€„ éº»å°‡é›²ç«¯è¨ˆåˆ†</h1>
            <a href="history.html" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded text-sm">æŸ¥çœ‹æ­·å²ç´€éŒ„</a>
            <div class="text-sm text-gray-400 flex items-center gap-2">
                åº• <input v-model.number="settings.base" type="number" @change="saveLocalSettings" class="w-12 bg-gray-700 text-center rounded p-1"> 
                å° <input v-model.number="settings.point" type="number" @change="saveLocalSettings" class="w-12 bg-gray-700 text-center rounded p-1">
            </div>
        </header>

        <section class="grid grid-cols-2 gap-3 mb-6">
            <div v-for="(playerName, index) in currentSeats" :key="index" 
                 class="relative p-3 rounded-lg border-2 flex flex-col justify-between transition-colors"
                 :class="activeWinner === index ? 'border-red-500 bg-gray-700' : (dealerIndex === index ? 'border-orange-500 bg-gray-800' : 'border-gray-600 bg-gray-800')">
                
                <div class="flex justify-between items-center mb-2">
                    <div class="flex items-center gap-1">
                        <button @click="setDealer(index)" 
                                class="text-xs font-bold px-2 py-1 rounded border dealer-badge"
                                :class="dealerIndex === index ? 'bg-orange-600 text-white border-orange-400 shadow-[0_0_8px_rgba(234,88,12,0.5)]' : 'bg-gray-700 text-gray-500 border-gray-600 hover:bg-gray-600'">
                            {{ dealerIndex === index ? 'èŠ' : 'åšèŠ' }}
                        </button>
                        <div v-if="dealerIndex === index" class="flex items-center bg-orange-900 rounded border border-orange-700 px-1">
                            <span class="text-[10px] text-orange-300 mr-1">é€£</span>
                            <input v-model.number="dealerCount" @change="saveLocalSettings" type="number" class="w-6 bg-transparent text-center text-xs font-bold text-white focus:outline-none">
                        </div>
                    </div>
                    <div class="text-xs font-bold text-gray-500">{{ directions[index] }}</div>
                </div>

                <input v-model="currentSeats[index]" @change="saveLocalSettings" placeholder="è¼¸å…¥åå­—" 
                       class="w-full bg-transparent text-lg font-bold text-center focus:outline-none mb-1 placeholder-gray-600 border-b border-transparent focus:border-gray-500">
                
                <div class="text-center text-3xl font-mono font-bold my-1" 
                     :class="getPlayerScore(playerName) >= 0 ? 'text-green-400' : 'text-red-400'">
                    {{ getPlayerScore(playerName) }}
                </div>

                <div class="flex justify-center gap-2 text-xs text-gray-400 mb-2 bg-black bg-opacity-20 py-1 rounded">
                    <span>èƒ¡ç‰Œ: <b class="text-white">{{ getPlayerStats(playerName).win }}</b></span> |
                    <span>è‡ªæ‘¸: <b class="text-yellow-400">{{ getPlayerStats(playerName).self }}</b></span> |
                    <span>æ”¾æ§: <b class="text-red-400">{{ getPlayerStats(playerName).lose }}</b></span>
                </div>

                <div class="grid grid-cols-1 mt-auto">
                    <button @click="openWinModal(index)" class="bg-red-600 hover:bg-red-700 text-white py-2 rounded font-bold shadow text-sm">èƒ¡ç‰Œ</button>
                </div>
            </div>
        </section>

        <section class="flex gap-2 mb-6 overflow-x-auto pb-2">
            <button @click="shuffleSeats" class="bg-purple-600 text-white px-4 py-2 rounded shadow shrink-0 text-sm">ğŸ² æŠ“ä½</button>
            <button @click="addDrawRecord" class="bg-gray-600 text-white px-4 py-2 rounded shadow shrink-0 text-sm">ğŸ’¨ è‡­èŠ(é€£èŠ)</button>
            <button @click="manualResetDealer" class="bg-orange-800 text-orange-100 px-4 py-2 rounded shadow shrink-0 text-sm">ğŸ”„ å¼·åˆ¶ä¸‹èŠ</button>
            <button @click="resetDB" class="bg-red-900 text-red-200 px-4 py-2 rounded shadow shrink-0 ml-auto text-xs">é‡ç½®è¨˜åˆ†æ¿</button>
        </section>

        <div v-if="matchState.isOpen" class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 p-4">
            <div class="bg-gray-800 p-5 rounded-lg max-w-sm w-full border border-gray-600 shadow-2xl">
                <h3 class="text-xl font-bold mb-4 text-center border-b border-gray-700 pb-2">
                    <span class="text-green-400">{{ currentSeats[matchState.winner] }}</span> èƒ¡ç‰Œ
                    <div v-if="matchState.winner === dealerIndex" class="text-xs text-orange-400 mt-1">èŠå®¶é€£ {{ dealerCount }} (åŠ  {{ 1 + dealerCount}} å°)</div>
                </h3>
                
                <div class="flex gap-2 mb-4">
                    <button @click="matchState.mode = 'self'" class="flex-1 py-3 rounded font-bold border-2" :class="matchState.mode === 'self' ? 'bg-yellow-600 border-yellow-400' : 'bg-gray-700 border-gray-600'">è‡ªæ‘¸</button>
                    <button @click="matchState.mode = 'discard'" class="flex-1 py-3 rounded font-bold border-2" :class="matchState.mode === 'discard' ? 'bg-blue-600 border-blue-400' : 'bg-gray-700 border-gray-600'">æŠ“äºº</button>
                </div>

                <div v-if="matchState.mode === 'discard'" class="mb-4 bg-gray-900 p-3 rounded">
                    <label class="block text-sm text-gray-400 mb-2">èª°æ”¾æ§ï¼Ÿ</label>
                    <div class="grid grid-cols-3 gap-2">
                        <template v-for="(player, idx) in currentSeats" :key="idx">
                            <button v-if="idx !== matchState.winner" @click="matchState.loser = idx" class="py-2 px-1 rounded text-sm border relative" :class="matchState.loser === idx ? 'bg-red-600 border-red-400' : 'bg-gray-700 border-gray-600'">
                                {{ player }}
                            </button>
                        </template>
                    </div>
                </div>

                <div class="mb-6 bg-gray-900 p-3 rounded">
                    <div class="flex items-center justify-center gap-4">
                        <button @click="matchState.tai > 0 ? matchState.tai-- : 0" class="bg-gray-700 w-12 h-12 rounded-full text-xl">-</button>
                        <span class="text-4xl font-mono font-bold w-16 text-center text-white">{{ matchState.tai }}</span>
                        <button @click="matchState.tai++" class="bg-gray-700 w-12 h-12 rounded-full text-xl">+</button>
                    </div>
                    <div class="mt-4 text-center border-t border-gray-700 pt-2 text-3xl text-green-400 font-bold font-mono">+{{ previewAmount.total }}</div>
                </div>

                <div class="flex gap-3">
                    <button @click="matchState.isOpen = false" class="flex-1 bg-gray-600 py-3 rounded">å–æ¶ˆ</button>
                    <button @click="confirmRound" class="flex-1 bg-green-600 py-3 rounded font-bold shadow-lg">ç¢ºèªè¨˜å¸³</button>
                </div>
            </div>
        </div>

        <section>
            <h3 class="text-lg font-bold mb-3 flex items-center text-gray-300">å°æˆ°ç´€éŒ„</h3>
            <div class="space-y-2">
                <div v-for="(log, index) in reversedLogs" :key="log.id" class="bg-gray-800 p-3 rounded flex justify-between items-center text-sm border-l-4 border-gray-700">
                    <div class="flex flex-col">
                        <span class="text-gray-500 text-xs flex items-center gap-1">
                            {{ new Date(log.time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) }}
                            <span v-if="log.dealer" class="text-orange-400 bg-orange-900 bg-opacity-30 px-1 rounded text-[10px]">
                                èŠ:{{ log.dealer }} (é€£{{ log.dealer_count }})
                            </span>
                        </span>
                        <div v-if="log.type === 'draw'" class="text-gray-400 font-bold mt-1">ğŸ’¨ è‡­èŠæµå±€</div>
                        <div v-else class="mt-1">
                            <span class="text-green-400 font-bold text-base">{{ log.winner }}</span>
                            <span class="text-gray-400 mx-1">{{ log.type === 'self' ? 'è‡ªæ‘¸' : 'èƒ¡' }}</span>
                            <span v-if="log.type === 'discard'" class="text-red-400 font-bold">{{ log.loser }}</span>
                            <span class="text-gray-500 ml-1 text-xs">({{ log.tai }}å°)</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="font-mono font-bold text-lg text-yellow-500">{{ log.type === 'draw' ? '--' : '+' + log.amount }}</div>
                        <button @click="deleteLog(log.id)" class="text-gray-600 hover:text-red-500 px-2">âœ•</button>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <script>
        const { createApp, ref, computed, onMounted } = Vue;

        // â˜…â˜…â˜… è«‹å¡«å…¥ä½ çš„ Supabase è³‡è¨Š â˜…â˜…â˜…
        const SUPABASE_URL = 'https://hyhmwlbsdvlssfmdsmux.supabase.co'; 
        const SUPABASE_KEY = 'sb_publishable_OZRd4Lcc7gK6aLMmbpxBng_YpSmnfnR'; 
        
        const supabase_con = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        createApp({
            setup() {
                const isLoading = ref(false);
                const settings = ref({ base: 20, point: 10 });
                const directions = ['æ±', 'å—', 'è¥¿', 'åŒ—'];
                const currentSeats = ref(['ç©å®¶A', 'ç©å®¶B', 'ç©å®¶C', 'ç©å®¶D']);
                const dealerIndex = ref(0); 
                const dealerCount = ref(0);
                const logs = ref([]);
                
                const matchState = ref({ isOpen: false, winner: null, loser: null, mode: 'self', tai: 1 });

                // ==========================================
                // â˜… æ–°å¢ï¼šå³æ™‚æ¡Œæ³åŒæ­¥ç³»çµ± (Game State)
                // ==========================================

                // 1. åˆæ¬¡è¼‰å…¥æ™‚ï¼Œå¾é›²ç«¯æŠ“å–ç›®å‰æ¡Œæ³
                const fetchGameState = async () => {
                    const { data, error } = await supabase_con
                        .from('game_state')
                        .select('*')
                        .eq('id', 1)
                        .single();
                    
                    if (data) {
                        currentSeats.value = data.seats || currentSeats.value;
                        dealerIndex.value = data.dealer_index ?? 0;
                        dealerCount.value = data.dealer_count ?? 0;
                        settings.value.base = data.base ?? 20;
                        settings.value.point = data.point ?? 10;
                    }
                };

                // 2. ç•¶æœ‰äººä¿®æ”¹åº§ä½/èŠå®¶/åº•å°æ™‚ï¼Œæ¨é€åˆ°é›²ç«¯
                const syncGameState = async () => {
                    await supabase_con.from('game_state').update({
                        seats: currentSeats.value,
                        dealer_index: dealerIndex.value,
                        dealer_count: dealerCount.value,
                        base: settings.value.base,
                        point: settings.value.point
                    }).eq('id', 1);
                };

                // 3. ç›£è½é›²ç«¯è®ŠåŒ– (å¦‚æœåˆ¥äººæ”¹äº†ï¼Œæˆ‘çš„ç•«é¢è¦è·Ÿè‘—è®Š)
                const listenToGameState = () => {
                    supabase_con
                        .channel('game_state_channel') // å»ºç«‹ä¸€å€‹ç›£è½é »é“
                        .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'game_state' }, payload => {
                            // ç•¶æ”¶åˆ°åˆ¥äººæ›´æ–°çš„å»£æ’­æ™‚ï¼Œè¦†è“‹æˆ‘ç›®å‰çš„ç•«é¢
                            const data = payload.new;
                            currentSeats.value = data.seats;
                            dealerIndex.value = data.dealer_index;
                            dealerCount.value = data.dealer_count;
                            settings.value.base = data.base;
                            settings.value.point = data.point;
                        })
                        .subscribe();
                };

                // (ç‚ºäº†è®“ HTML ç¶å®šçš„ @change ç¹¼çºŒé‹ä½œï¼ŒæŠŠèˆŠåç¨±æŒ‡æ´¾çµ¦æ–°åŠŸèƒ½)
                const saveLocalSettings = syncGameState; 

                // ==========================================
                // ä»¥ä¸‹ç‚ºåŸæœ¬çš„æˆ°ç¸¾å­˜å–é‚è¼¯ (Logs)
                // ==========================================

                const fetchLogs = async () => {
                    isLoading.value = true;
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    const todayTimestamp = today.getTime();

                    const { data, error } = await supabase_con
                        .from('logs')
                        .select('*')
                        .gte('time', todayTimestamp)
                        .order('time', { ascending: true });
                    
                    if (!error) logs.value = data || [];
                    isLoading.value = false;
                };

                const insertLog = async (newLog) => {
                    isLoading.value = true;
                    const dbLog = { ...newLog, dealer_count: newLog.dealerCount };
                    delete dbLog.dealerCount; 

                    const { error } = await supabase_con.from('logs').insert([dbLog]);
                    if (error) alert('å¯«å…¥å¤±æ•—: ' + error.message);
                    else await fetchLogs(); 
                    isLoading.value = false;
                };

                const deleteLog = async (id) => {
                    if(!confirm("ç¢ºå®šå¾è³‡æ–™åº«æ°¸ä¹…åˆªé™¤æ­¤ç´€éŒ„ï¼Ÿ")) return;
                    isLoading.value = true;
                    await supabase_con.from('logs').delete().eq('id', id);
                    await fetchLogs();
                    isLoading.value = false;
                };
                
                const resetDB = async () => {
                    if(!confirm("è­¦å‘Šï¼šé€™å°‡æ¸…ç©ºã€ä»Šå¤©ã€‘çš„æ‰€æœ‰ç´€éŒ„ï¼")) return;
                    isLoading.value = true;
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    await supabase_con.from('logs').delete().gte('time', today.getTime());
                    logs.value = [];
                    dealerIndex.value = 0;
                    dealerCount.value = 0;
                    syncGameState(); // åŒæ­¥é‡ç½®ç‹€æ…‹çµ¦æ‰€æœ‰äºº
                    isLoading.value = false;
                };

                // --- æ ¸å¿ƒè¨ˆç®— ---
                const calculateTransaction = (log, playerName) => {
                    if (log.players && Array.isArray(log.players)) {
                        if (!log.players.includes(playerName)) return 0;
                    }
                    const base = settings.value.base;
                    const point = settings.value.point;
                    const logDealer = log.dealer; 
                    const logDealerCount = log.dealer_count || 0; 

                    const getPay = (tai, isDealerInvolved) => {
                        let effectiveTai = tai;
                        if (isDealerInvolved) effectiveTai += 1 + (logDealerCount);
                        return base + (effectiveTai * point);
                    }

                    if (log.type === 'draw') return 0;
                    if (log.winner === playerName) return log.amount; 

                    if (log.type === 'self') {
                        const winnerIsDealer = (log.winner === logDealer);
                        const amIDealer = (playerName === logDealer);
                        if (winnerIsDealer) return -getPay(log.tai, true);
                        else return amIDealer ? -getPay(log.tai, true) : -getPay(log.tai, false);
                    } else if (log.type === 'discard') {
                        if (log.loser === playerName) {
                            const isDealerInvolved = (log.winner === logDealer || log.loser === logDealer);
                            return -getPay(log.tai, isDealerInvolved);
                        }
                    }
                    return 0;
                };

                const getPlayerScore = (name) => {
                    if (!name) return 0;
                    let total = 0;
                    logs.value.forEach(log => total += calculateTransaction(log, name));
                    return Math.round(total);
                };

                const getPlayerStats = (name) => {
                    if (!name) return { win: 0, self: 0, lose: 0 };
                    let stats = { win: 0, self: 0, lose: 0 };
                    logs.value.forEach(log => {
                        if (log.type === 'draw') return;
                        if (log.players && Array.isArray(log.players) && !log.players.includes(name)) return;

                        if (log.winner === name) {
                            stats.win++;
                            if (log.type === 'self') stats.self++;
                        }
                        if (log.type === 'discard' && log.loser === name) stats.lose++;
                    });
                    return stats;
                };

                const previewAmount = computed(() => {
                    const base = settings.value.base;
                    const point = settings.value.point;
                    const tai = matchState.value.tai;
                    const winnerIdx = matchState.value.winner;
                    const loserIdx = matchState.value.loser;
                    const winnerIsDealer = (winnerIdx === dealerIndex.value);
                    const loserIsDealer = (loserIdx === dealerIndex.value);
                    
                    const payNormal = base + (tai * point);     
                    const dealerExtraTai = 1 + dealerCount.value;
                    const payDealer = base + ((tai + dealerExtraTai) * point);

                    if (matchState.value.mode === 'self') {
                        if (winnerIsDealer) return { total: payDealer * 3, detail: [payDealer], isDealerInvolved: true };
                        else {
                            const total = payDealer + (payNormal * 2);
                            return { total, dealerPays: payDealer, playerPays: payNormal, isDealerInvolved: true };
                        }
                    } else {
                        if (loserIdx === null) return { total: 0 };
                        const isDealerInvolved = winnerIsDealer || loserIsDealer;
                        const total = isDealerInvolved ? payDealer : payNormal;
                        return { total, isDealerInvolved };
                    }
                });

                const reversedLogs = computed(() => [...logs.value].reverse());

                // --- æ“ä½œ ---
                const setDealer = (index) => {
                    if (dealerIndex.value !== index) {
                        if(confirm(`æ› ${currentSeats.value[index]} åšèŠï¼Ÿé€£èŠæ•¸æ­¸é›¶ã€‚`)){
                            dealerIndex.value = index;
                            dealerCount.value = 0;
                            syncGameState(); // åŒæ­¥åˆ°é›²ç«¯
                        }
                    }
                };

                const openWinModal = (index) => {
                    matchState.value = { isOpen: true, winner: index, loser: null, mode: 'self', tai: 1 };
                };

                const confirmRound = () => {
                    const { winner, loser, mode, tai } = matchState.value;
                    if (mode === 'discard' && loser === null) return alert("è«‹é¸æ“‡æ”¾æ§è€…");
                    if (mode === 'discard' && winner === loser) return alert("è´å®¶è¼¸å®¶ä¸èƒ½åŒä¸€äºº");

                    const currentDealerName = currentSeats.value[dealerIndex.value];
                    const amount = previewAmount.value.total;

                    const newLog = {
                        id: Date.now(),
                        time: Date.now(),
                        winner: currentSeats.value[winner],
                        loser: mode === 'discard' ? currentSeats.value[loser] : 'ALL',
                        type: mode,
                        tai: tai,
                        amount: amount,
                        dealer: currentDealerName, 
                        dealerCount: dealerCount.value, 
                        base: settings.value.base,
                        point: settings.value.point,
                        players: [...currentSeats.value]
                    };

                    insertLog(newLog);

                    const winnerIsDealer = (winner === dealerIndex.value);
                    if (winnerIsDealer) dealerCount.value++;
                    else {
                        dealerCount.value = 0;
                        dealerIndex.value = (dealerIndex.value + 1) % 4;
                    }
                    
                    matchState.value.isOpen = false;
                    syncGameState(); // çµç®—å¾ŒåŒæ­¥æœ€æ–°çš„èŠå®¶ç‹€æ…‹
                };

                const addDrawRecord = () => {
                    const newLog = {
                        id: Date.now(),
                        time: Date.now(),
                        type: 'draw',
                        dealer: currentSeats.value[dealerIndex.value],
                        dealerCount: dealerCount.value,
                        players: [...currentSeats.value]
                    };
                    insertLog(newLog);
                    dealerCount.value++;
                    syncGameState(); // è‡­èŠå¾ŒåŒæ­¥é€£èŠæ•¸
                };

                const manualResetDealer = () => {
                    if(confirm("å¼·åˆ¶æ›ä¸‹å®¶åšèŠï¼Ÿ")) {
                        dealerCount.value = 0;
                        dealerIndex.value = (dealerIndex.value + 1) % 4;
                        syncGameState();
                    }
                };

                const shuffleSeats = () => {
                    if(!confirm("é‡æ–°æŠ“ä½ï¼Ÿ")) return;
                    let array = [...currentSeats.value];
                    for (let i = array.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [array[i], array[j]] = [array[j], array[i]];
                    }
                    currentSeats.value = array;
                    dealerIndex.value = 0; 
                    dealerCount.value = 0;
                    syncGameState(); // æ´—ç‰Œå¾Œé¦¬ä¸ŠåŒæ­¥çµ¦å…¶ä»–äºº
                };

                // ç•¶ç¨‹å¼å•Ÿå‹•æ™‚...
                onMounted(() => {
                    fetchLogs();          // 1. æŠ“ä»Šæ—¥æˆ°ç¸¾
                    fetchGameState();     // 2. æŠ“é›²ç«¯æ¡Œæ³
                    listenToGameState();  // 3. é–‹å•Ÿå³æ™‚ç›£è½å¤©ç·š
                });

                return {
                    settings, directions, currentSeats, dealerIndex, dealerCount, logs, reversedLogs,
                    matchState, previewAmount, isLoading,
                    getPlayerScore, getPlayerStats,
                    setDealer, openWinModal, confirmRound,
                    shuffleSeats, addDrawRecord, deleteLog, resetDB, manualResetDealer, saveLocalSettings
                };
            }
        }).mount('#app');
    </script>
</body>
</html>

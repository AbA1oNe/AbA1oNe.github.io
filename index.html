<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éº»å°‡è¨ˆåˆ†æ¿ (é€£èŠè‡ªå‹•ç‰ˆ)</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #1a202c; color: white; }
        .dealer-badge { transition: all 0.3s ease; }
        /* éš±è— number input çš„ç®­é ­ */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body>
    <div id="app" class="max-w-2xl mx-auto p-4 pb-24">
        
        <header class="flex justify-between items-center mb-4 border-b border-gray-600 pb-4">
            <h1 class="text-xl font-bold text-green-400">ğŸ€„ éº»å°‡è¨ˆåˆ†åŠ©æ‰‹</h1>
            <div class="text-sm text-gray-400 flex items-center gap-2">
                åº• <input v-model.number="settings.base" type="number" class="w-12 bg-gray-700 text-center rounded p-1"> 
                å° <input v-model.number="settings.point" type="number" class="w-12 bg-gray-700 text-center rounded p-1">
            </div>
        </header>

        <section class="grid grid-cols-2 gap-3 mb-6">
            <div v-for="(playerName, index) in currentSeats" :key="index" 
                 class="relative p-3 rounded-lg border-2 flex flex-col justify-between transition-colors"
                 :class="activeWinner === index ? 'border-red-500 bg-gray-700' : (dealerIndex === index ? 'border-orange-500 bg-gray-800' : 'border-gray-600 bg-gray-800')">
                
                <div class="flex justify-between items-center mb-2">
                    <div class="flex items-center gap-1">
                        <button @click="setDealer(index)" 
                                class="text-xs font-bold px-2 py-1 rounded border dealer-badge"
                                :class="dealerIndex === index ? 'bg-orange-600 text-white border-orange-400 shadow-[0_0_8px_rgba(234,88,12,0.5)]' : 'bg-gray-700 text-gray-500 border-gray-600 hover:bg-gray-600'">
                            {{ dealerIndex === index ? 'èŠ' : 'åšèŠ' }}
                        </button>
                        
                        <div v-if="dealerIndex === index" class="flex items-center bg-orange-900 rounded border border-orange-700 px-1">
                            <span class="text-[10px] text-orange-300 mr-1">é€£</span>
                            <input v-model.number="dealerCount" type="number" class="w-6 bg-transparent text-center text-xs font-bold text-white focus:outline-none">
                        </div>
                    </div>
                    <div class="text-xs font-bold text-gray-500">{{ directions[index] }}</div>
                </div>

                <input v-model="currentSeats[index]" placeholder="è¼¸å…¥åå­—" 
                       class="w-full bg-transparent text-lg font-bold text-center focus:outline-none mb-1 placeholder-gray-600 border-b border-transparent focus:border-gray-500">
                
                <div class="text-center text-3xl font-mono font-bold my-1" 
                     :class="getPlayerScore(playerName) >= 0 ? 'text-green-400' : 'text-red-400'">
                    {{ getPlayerScore(playerName) }}
                </div>

                <div class="flex justify-center gap-2 text-xs text-gray-400 mb-2 bg-black bg-opacity-20 py-1 rounded">
                    <span>èƒ¡: <b class="text-white">{{ getPlayerStats(playerName).win }}</b></span>
                    <span>|</span>
                    <span>è‡ª: <b class="text-yellow-400">{{ getPlayerStats(playerName).self }}</b></span>
                    <span>|</span>
                    <span>æ”¾: <b class="text-red-400">{{ getPlayerStats(playerName).lose }}</b></span>
                </div>

                <div class="grid grid-cols-1 mt-auto">
                    <button @click="openWinModal(index)" class="bg-red-600 hover:bg-red-700 text-white py-2 rounded font-bold shadow text-sm">
                        èƒ¡ç‰Œ
                    </button>
                </div>
            </div>
        </section>

        <section class="flex gap-2 mb-6 overflow-x-auto pb-2">
            <button @click="shuffleSeats" class="bg-purple-600 text-white px-4 py-2 rounded shadow shrink-0 text-sm">ğŸ² æŠ“ä½</button>
            <button @click="addDrawRecord" class="bg-gray-600 text-white px-4 py-2 rounded shadow shrink-0 text-sm">ğŸ’¨ è‡­èŠ(é€£èŠ)</button>
            <button @click="manualResetDealer" class="bg-orange-800 text-orange-100 px-4 py-2 rounded shadow shrink-0 text-sm">ğŸ”„ å¼·åˆ¶ä¸‹èŠ</button>
            <button @click="resetData" class="bg-red-900 text-red-200 px-4 py-2 rounded shadow shrink-0 ml-auto text-xs">é‡ç½®</button>
        </section>

        <div v-if="matchState.isOpen" class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 p-4">
            <div class="bg-gray-800 p-5 rounded-lg max-w-sm w-full border border-gray-600 shadow-2xl">
                
                <h3 class="text-xl font-bold mb-4 text-center border-b border-gray-700 pb-2">
                    <span class="text-green-400">{{ currentSeats[matchState.winner] }}</span> èƒ¡ç‰Œ
                    <div v-if="matchState.winner === dealerIndex" class="text-xs text-orange-400 mt-1">èŠå®¶é€£ {{ dealerCount }} (åŠ  {{ 1 + dealerCount }} å°)</div>
                </h3>
                
                <div class="flex gap-2 mb-4">
                    <button @click="matchState.mode = 'self'" 
                            class="flex-1 py-3 rounded font-bold transition-colors border-2"
                            :class="matchState.mode === 'self' ? 'bg-yellow-600 border-yellow-400 text-white' : 'bg-gray-700 border-gray-600 text-gray-400'">
                        è‡ªæ‘¸
                    </button>
                    <button @click="matchState.mode = 'discard'" 
                            class="flex-1 py-3 rounded font-bold transition-colors border-2"
                            :class="matchState.mode === 'discard' ? 'bg-blue-600 border-blue-400 text-white' : 'bg-gray-700 border-gray-600 text-gray-400'">
                        æŠ“äºº
                    </button>
                </div>

                <div v-if="matchState.mode === 'discard'" class="mb-4 bg-gray-900 p-3 rounded">
                    <label class="block text-sm text-gray-400 mb-2">èª°æ”¾æ§ï¼Ÿ</label>
                    <div class="grid grid-cols-3 gap-2">
                        <template v-for="(player, idx) in currentSeats" :key="idx">
                            <button v-if="idx !== matchState.winner"
                                    @click="matchState.loser = idx"
                                    class="py-2 px-1 rounded text-sm truncate transition-colors border relative"
                                    :class="matchState.loser === idx ? 'bg-red-600 border-red-400 text-white' : 'bg-gray-700 border-gray-600 text-gray-300'">
                                {{ player }}
                                <span v-if="idx === dealerIndex" class="absolute top-0 right-0 w-2 h-2 bg-orange-500 rounded-full"></span>
                            </button>
                        </template>
                    </div>
                </div>

                <div class="mb-6 bg-gray-900 p-3 rounded">
                    <label class="block text-sm text-gray-400 mb-2 text-center">å°æ•¸ (åƒ…è¼¸å…¥ç‰Œå‹å°)</label>
                    <div class="flex items-center justify-center gap-4">
                        <button @click="matchState.tai > 0 ? matchState.tai-- : 0" class="bg-gray-700 w-12 h-12 rounded-full text-xl shadow">-</button>
                        <span class="text-4xl font-mono font-bold w-16 text-center text-white">{{ matchState.tai }}</span>
                        <button @click="matchState.tai++" class="bg-gray-700 w-12 h-12 rounded-full text-xl shadow">+</button>
                    </div>
                    
                    <div class="mt-4 text-center border-t border-gray-700 pt-2 space-y-1">
                        <div class="text-xs text-gray-500">é è¨ˆç¸½æ”¶å…¥</div>
                        <div class="text-3xl text-green-400 font-bold font-mono">+{{ previewAmount.total }}</div>
                        
                        <div class="text-xs text-gray-400 mt-2">
                            <div v-if="matchState.mode === 'self' && matchState.winner === dealerIndex">
                                <span class="text-orange-400">èŠå®¶é€£{{ dealerCount }}é€šæ®º</span>
                                <div class="text-[10px] text-gray-500">æ¯å®¶ä»˜: {{ previewAmount.detail[0] }}</div>
                            </div>
                            <div v-else-if="matchState.mode === 'self'">
                                èŠå®¶ä»˜: <span class="text-red-300">{{ previewAmount.dealerPays }}</span> 
                                (å«é€£èŠ{{ 1 + dealerCount }}å°)
                                <br>
                                é–’å®¶ä»˜: <span class="text-gray-300">{{ previewAmount.playerPays }}</span>
                            </div>
                            <div v-else>
                                <div v-if="previewAmount.isDealerInvolved" class="text-orange-400">
                                    å«èŠå®¶é€£{{ dealerCount }} (åŠ  {{ 1 + dealerCount }} å°)
                                </div>
                                æ”¾æ§è€…ä»˜: <span class="text-red-400">{{ previewAmount.total }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex gap-3">
                    <button @click="matchState.isOpen = false" class="flex-1 bg-gray-600 py-3 rounded text-gray-200">å–æ¶ˆ</button>
                    <button @click="confirmRound" class="flex-1 bg-green-600 py-3 rounded font-bold text-white shadow-lg">ç¢ºèªè¨˜å¸³</button>
                </div>
            </div>
        </div>

        <section>
            <h3 class="text-lg font-bold mb-3 flex items-center text-gray-300">
                å°æˆ°ç´€éŒ„
            </h3>
            <div class="space-y-2">
                <div v-for="(log, index) in reversedLogs" :key="log.id" class="bg-gray-800 p-3 rounded flex justify-between items-center text-sm border-l-4 border-gray-700">
                    <div class="flex flex-col">
                        <span class="text-gray-500 text-xs flex items-center gap-1">
                            {{ new Date(log.time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) }}
                            <span v-if="log.dealer" class="text-orange-400 bg-orange-900 bg-opacity-30 px-1 rounded text-[10px]">
                                èŠ:{{ log.dealer }} (é€£{{ log.dealerCount }})
                            </span>
                        </span>
                        
                        <div v-if="log.type === 'draw'" class="text-gray-400 font-bold mt-1">ğŸ’¨ è‡­èŠæµå±€</div>
                        <div v-else class="mt-1">
                            <span class="text-green-400 font-bold text-base">{{ log.winner }}</span>
                            <span class="text-gray-400 mx-1">{{ log.type === 'self' ? 'è‡ªæ‘¸' : 'èƒ¡' }}</span>
                            <span v-if="log.type === 'discard'" class="text-red-400 font-bold">{{ log.loser }}</span>
                            <span class="text-gray-500 ml-1 text-xs">({{ log.tai }}å°)</span>
                        </div>
                    </div>

                    <div class="flex items-center gap-3">
                        <div class="font-mono font-bold text-lg text-yellow-500">
                            {{ log.type === 'draw' ? '--' : '+' + log.amount }}
                        </div>
                        <button @click="deleteLog(log.id)" class="text-gray-600 hover:text-red-500 px-2">âœ•</button>
                    </div>
                </div>
            </div>
        </section>

    </div>

    <script>
        const { createApp, ref, computed, onMounted, watch } = Vue;

        createApp({
            setup() {
                // è³‡æ–™èˆ‡è¨­å®š
                const settings = ref({ base: 30, point: 10 });
                const directions = ['æ±', 'å—', 'è¥¿', 'åŒ—'];
                const currentSeats = ref(['ç©å®¶A', 'ç©å®¶B', 'ç©å®¶C', 'ç©å®¶D']);
                const dealerIndex = ref(0); 
                const dealerCount = ref(0); // é€£èŠæ•¸
                const logs = ref([]);
                
                const matchState = ref({
                    isOpen: false,
                    winner: null, 
                    loser: null,
                    mode: 'self',
                    tai: 1
                });

                // --- æ ¸å¿ƒè¨ˆç®—é‚è¼¯ ---

                // è¨ˆç®—å–®æ¬¡äº¤æ˜“ä¸­ï¼ŒæŸå€‹ç©å®¶æ‡‰è©²ä»˜å¤šå°‘éŒ¢
                const calculateTransaction = (log, playerName) => {
                    const base = log.base || settings.value.base;
                    const point = log.point || settings.value.point;
                    const logDealer = log.dealer; 
                    const logDealerCount = log.dealerCount || 0;

                    // â˜… è¨ˆç®—æ‡‰ä»˜é‡‘é¡æ ¸å¿ƒå…¬å¼
                    // isDealerInvolved: é€™æ¬¡æ”¯ä»˜é—œä¿‚ä¸­æ˜¯å¦æœ‰èŠå®¶åƒèˆ‡
                    const getPay = (tai, isDealerInvolved) => {
                        let effectiveTai = tai;
                        if (isDealerInvolved) {
                            // èŠå®¶å°(1) + é€£èŠæ‹‰èŠn
                            effectiveTai += 1 + logDealerCount;
                        }
                        return base + (effectiveTai * point);
                    }

                    if (log.type === 'draw') return 0;

                    // æˆ‘æ˜¯è´å®¶ -> æ”¶éŒ¢ (ç›´æ¥è®€å–ç´€éŒ„çš„ç¸½é¡)
                    if (log.winner === playerName) return log.amount; 

                    // æˆ‘ä¸æ˜¯è´å®¶ï¼Œæª¢æŸ¥æˆ‘æ˜¯å¦è¦ä»˜éŒ¢
                    if (log.type === 'self') {
                        const winnerIsDealer = (log.winner === logDealer);
                        const amIDealer = (playerName === logDealer);

                        if (winnerIsDealer) {
                            // èŠå®¶è‡ªæ‘¸ï¼šæ¯å®¶éƒ½ä»˜ (å° + 1 + 2n)
                            return -getPay(log.tai, true);
                        } else {
                            // é–’å®¶è‡ªæ‘¸
                            if (amIDealer) {
                                // æˆ‘æ˜¯èŠå®¶ï¼Œæˆ‘ä»˜ (å° + 1 + 2n)
                                return -getPay(log.tai, true);
                            } else {
                                // æˆ‘æ˜¯é–’å®¶ï¼Œæˆ‘ä»˜ (å°)
                                return -getPay(log.tai, false);
                            }
                        }
                    } else if (log.type === 'discard') {
                        if (log.loser === playerName) {
                            // åˆ¤æ–·æ˜¯å¦æœ‰èŠå®¶åƒèˆ‡ (è´å®¶æ˜¯èŠ OR è¼¸å®¶æ˜¯èŠ)
                            const isDealerInvolved = (log.winner === logDealer || log.loser === logDealer);
                            return -getPay(log.tai, isDealerInvolved);
                        }
                    }
                    return 0;
                };

                const getPlayerScore = (name) => {
                    if (!name) return 0;
                    let total = 0;
                    logs.value.forEach(log => {
                        total += calculateTransaction(log, name);
                    });
                    return Math.round(total);
                };

                const getPlayerStats = (name) => {
                    if (!name) return { win: 0, self: 0, lose: 0 };
                    let stats = { win: 0, self: 0, lose: 0 };
                    logs.value.forEach(log => {
                        if (log.type === 'draw') return;
                        if (log.winner === name) {
                            stats.win++;
                            if (log.type === 'self') stats.self++;
                        }
                        if (log.type === 'discard' && log.loser === name) {
                            stats.lose++;
                        }
                    });
                    return stats;
                };

                // é è¦½é‡‘é¡ (çµ¦ Modal é¡¯ç¤ºç”¨)
                const previewAmount = computed(() => {
                    const base = settings.value.base;
                    const point = settings.value.point;
                    const tai = matchState.value.tai;
                    const winnerIdx = matchState.value.winner;
                    const loserIdx = matchState.value.loser;
                    
                    const winnerIsDealer = (winnerIdx === dealerIndex.value);
                    const loserIsDealer = (loserIdx === dealerIndex.value);
                    
                    // å–®åƒ¹è¨ˆç®—
                    const payNormal = base + (tai * point);     
                    // èŠå®¶åƒèˆ‡åƒ¹ï¼šå° + 1 + 2n
                    const dealerExtraTai = 1 + (dealerCount.value);
                    const payDealer = base + ((tai + dealerExtraTai) * point);

                    if (matchState.value.mode === 'self') {
                        if (winnerIsDealer) {
                            // èŠå®¶è‡ªæ‘¸ï¼šä¸‰å®¶éƒ½ä»˜ Dealer Price
                            return { total: payDealer * 3, detail: [payDealer], isDealerInvolved: true };
                        } else {
                            // é–’å®¶è‡ªæ‘¸ï¼šèŠå®¶ä»˜ Dealer Priceï¼Œå¦å¤–å…©å®¶ä»˜ Normal
                            const total = payDealer + (payNormal * 2);
                            return { total, dealerPays: payDealer, playerPays: payNormal, isDealerInvolved: true };
                        }
                    } else {
                        // æ”¾æ§
                        if (loserIdx === null) return { total: 0 };
                        const isDealerInvolved = winnerIsDealer || loserIsDealer;
                        const total = isDealerInvolved ? payDealer : payNormal;
                        return { total, isDealerInvolved };
                    }
                });

                // --- æ“ä½œ ---
                const setDealer = (index) => {
                    // å¦‚æœé»æ“Šå·²ç¶“æ˜¯èŠå®¶çš„äººï¼Œä¸å‹•ä½œï¼ˆé¿å…èª¤è§¸é‡ç½®ï¼‰
                    if (dealerIndex.value !== index) {
                        if(confirm(`ç¢ºå®šæ› ${currentSeats.value[index]} åšèŠï¼Ÿé€£èŠæ•¸å°‡æ­¸é›¶ã€‚`)){
                            dealerIndex.value = index;
                            dealerCount.value = 0;
                            saveData(); 
                        }
                    }
                };

                const openWinModal = (index) => {
                    matchState.value = {
                        isOpen: true,
                        winner: index,
                        loser: null,
                        mode: 'self',
                        tai: 1
                    };
                };

                const confirmRound = () => {
                    const { winner, loser, mode, tai } = matchState.value;
                    
                    if (mode === 'discard' && loser === null) return alert("è«‹é¸æ“‡æ”¾æ§è€…");
                    if (mode === 'discard' && winner === loser) return alert("è´å®¶è¼¸å®¶ä¸èƒ½åŒä¸€äºº");

                    const currentDealerName = currentSeats.value[dealerIndex.value];
                    const amount = previewAmount.value.total;

                    // è¨˜éŒ„
                    logs.value.push({
                        id: Date.now(),
                        time: Date.now(),
                        winner: currentSeats.value[winner],
                        loser: mode === 'discard' ? currentSeats.value[loser] : 'ALL',
                        type: mode,
                        tai: tai,
                        amount: amount,
                        dealer: currentDealerName, 
                        dealerCount: dealerCount.value, // å­˜ç•¶ä¸‹é€£èŠæ•¸
                        base: settings.value.base,
                        point: settings.value.point 
                    });

                    // â˜… è‡ªå‹•åŒ–èŠå®¶é‚è¼¯
                    const winnerIsDealer = (winner === dealerIndex.value);
                    const loserIsDealer = (loser === dealerIndex.value);

                    if (winnerIsDealer) {
                        // èŠå®¶è´ -> é€£èŠ + 1
                        dealerCount.value++;
                    } else {
                        // é–’å®¶è´ -> èŠå®¶ä¸‹èŠ
                        // è¦å‰‡åˆ¤æ–·ï¼šè‹¥æ˜¯é–’å®¶èƒ¡é–’å®¶ï¼ŒèŠå®¶æ˜¯å¦ä¸‹èŠï¼Ÿ
                        // å°ç£è¦å‰‡é€šå¸¸æ˜¯ï¼šåªè¦èŠå®¶æ²’èƒ¡ç‰Œï¼ˆä¸”æ²’æµå±€ï¼‰ï¼Œå°±ä¸‹èŠã€‚
                        // æ‰€ä»¥é–’å®¶äº’æ‰“ï¼ŒèŠå®¶ä¹Ÿè¦ä¸‹èŠã€‚
                        moveToNextDealer();
                    }
                    
                    matchState.value.isOpen = false;
                    saveData();
                };

                const addDrawRecord = () => {
                    logs.value.push({
                        id: Date.now(),
                        time: Date.now(),
                        type: 'draw',
                        dealer: currentSeats.value[dealerIndex.value],
                        dealerCount: dealerCount.value
                    });
                    // è‡­èŠ -> é€£èŠ + 1
                    dealerCount.value++;
                    saveData();
                };

                const moveToNextDealer = () => {
                    dealerCount.value = 0;
                    dealerIndex.value = (dealerIndex.value + 1) % 4;
                };

                const manualResetDealer = () => {
                    if(confirm("å¼·åˆ¶æ›ä¸‹å®¶åšèŠï¼Ÿ")) moveToNextDealer();
                    saveData();
                };

                const shuffleSeats = () => {
                    if(!confirm("é‡æ–°æŠ“ä½ï¼Ÿ")) return;
                    let array = [...currentSeats.value];
                    for (let i = array.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [array[i], array[j]] = [array[j], array[i]];
                    }
                    currentSeats.value = array;
                    dealerIndex.value = 0; 
                    dealerCount.value = 0;
                    saveData();
                };

                const deleteLog = (id) => {
                    if(!confirm("åˆªé™¤æ­¤ç´€éŒ„ï¼Ÿ(æ³¨æ„ï¼šä¸æœƒå¾©åŸé€£èŠæ•¸)")) return;
                    logs.value = logs.value.filter(l => l.id !== id);
                    saveData();
                };

                const resetData = () => {
                    if(confirm("æ¸…ç©ºæ‰€æœ‰è³‡æ–™ï¼Ÿ")) {
                        logs.value = [];
                        dealerIndex.value = 0;
                        dealerCount.value = 0;
                        saveData();
                    }
                };

                const reversedLogs = computed(() => [...logs.value].reverse());

                const saveData = () => {
                    localStorage.setItem('mj_seats', JSON.stringify(currentSeats.value));
                    localStorage.setItem('mj_logs', JSON.stringify(logs.value));
                    localStorage.setItem('mj_settings', JSON.stringify(settings.value));
                    localStorage.setItem('mj_dealer', dealerIndex.value);
                    localStorage.setItem('mj_dealerCount', dealerCount.value);
                };

                const loadData = () => {
                    const s = localStorage.getItem('mj_seats');
                    const l = localStorage.getItem('mj_logs');
                    const st = localStorage.getItem('mj_settings');
                    const d = localStorage.getItem('mj_dealer');
                    const dc = localStorage.getItem('mj_dealerCount');
                    
                    if (s) currentSeats.value = JSON.parse(s);
                    if (l) logs.value = JSON.parse(l);
                    if (st) settings.value = JSON.parse(st);
                    if (d) dealerIndex.value = parseInt(d);
                    if (dc) dealerCount.value = parseInt(dc);
                };

                onMounted(loadData);

                return {
                    settings, directions, currentSeats, dealerIndex, dealerCount, logs, reversedLogs,
                    matchState, previewAmount,
                    getPlayerScore, getPlayerStats,
                    setDealer, openWinModal, confirmRound,
                    shuffleSeats, addDrawRecord, deleteLog, resetData, manualResetDealer
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
